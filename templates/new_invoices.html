{% extends 'base.html' %}
{% block title %}New Invoice | GST Bill Book{% endblock %}

{% block content %}
<section class="p-5 bg-white shadow rounded">
    <h2>Create New Invoice</h2>

    <form action="{{ url_for('generate_invoice') }}" method="post" id="invoice-form">
                <div class="mb-3">
                    <label for="customer_name" class="form-label">Customer Name:</label>
                    <input type="text" class="form-control" id="customer_name" name="customer_name" required>
                </div>
                <div class="mb-3">
                    <label for="invoice_date" class="form-label">Invoice Date:</label>
                    <input type="date" class="form-control" id="invoice_date" name="invoice_date" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Invoice Items:</label>
                    <div id="invoice_items">
                        <div class="item">
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control item-name" name="item[]" placeholder="Item"
                                        required>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control item-quantity" name="quantity[]"
                                        placeholder="Quantity" required>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control item-price" name="price[]"
                                        placeholder="Price" required>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-sm btn-danger remove-item">Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-success mt-2" onclick="addItem()">Add Item</button>
                </div>

                <div class="mb-3">
                    <label for="discount" class="form-label">Discount:</label>
                    <input type="number" class="form-control" id="discount" name="discount" value="0">
                </div>

                <div class="mb-3">
                    <label for="tax" class="form-label">Tax:</label>
                    <input type="number" class="form-control" id="tax" name="tax" value="0">
                </div>
                <input type="hidden" name="item_names" id="item_names">
                <input type="hidden" name="item_quantities" id="item_quantities">
                <input type="hidden" name="item_prices" id="item_prices">

                <button type="submit" class="btn btn-primary">Generate Invoice</button>
            </form>
</section>
{% endblock %}

{% block scripts %}
<script>
        function addItem() {
            var newItem = document.createElement('div');
            newItem.classList.add('item');
            newItem.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control item-name" name="item[]" placeholder="Item" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control item-quantity" name="quantity[]" placeholder="Quantity" required>
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control item-price" name="price[]" placeholder="Price" required>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-sm btn-danger remove-item">Remove</button>
                    </div>
                </div>
            `;
            document.getElementById('invoice_items').appendChild(newItem);
             // Add event listener to the remove button of the new item
             newItem.querySelector('.remove-item').addEventListener('click', function() {
                newItem.remove();
            });
        }

        document.addEventListener('click', function(e) {
            if (e.target && e.target.classList.contains('remove-item')) {
                e.target.closest('.item').remove();
            }
        });
        document.getElementById('invoice-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission

            // Get all item names, quantities, and prices
            let itemNames = Array.from(document.querySelectorAll('.item-name')).map(item => item.value);
            let itemQuantities = Array.from(document.querySelectorAll('.item-quantity')).map(item => item.value);
            let itemPrices = Array.from(document.querySelectorAll('.item-price')).map(item => item.value);

            // Set the values of the hidden input fields
            document.getElementById('item_names').value = JSON.stringify(itemNames);
            document.getElementById('item_quantities').value = JSON.stringify(itemQuantities);
            document.getElementById('item_prices').value = JSON.stringify(itemPrices);

            // Now submit the form
            this.submit();
        });
</script>
{% endblock %}
